<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mastering asyncio &mdash; Telethon 0.145 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="A Word of Warning" href="../examples/word-of-warning.html" />
    <link rel="prev" title="HTTP Bot API vs MTProto" href="botapi-vs-mtproto.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Telethon
          </a>
              <div class="version">
                0.145
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">First Steps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../basic/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic/signing-in.html">Signing In</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic/quick-start.html">Quick-Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic/updates.html">Updates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic/next-steps.html">Next Steps</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Quick References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick-references/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick-references/client-reference.html">Client Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick-references/events-reference.html">Events Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick-references/objects-reference.html">Objects Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Concepts</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="strings.html">String-based Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="entities.html">Entities</a></li>
<li class="toctree-l1"><a class="reference internal" href="chats-vs-channels.html">Chats vs Channels</a></li>
<li class="toctree-l1"><a class="reference internal" href="updates.html">Updates in Depth</a></li>
<li class="toctree-l1"><a class="reference internal" href="sessions.html">Session Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="full-api.html">The Full API</a></li>
<li class="toctree-l1"><a class="reference internal" href="errors.html">RPC Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="botapi-vs-mtproto.html">HTTP Bot API vs MTProto</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Mastering asyncio</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#what-s-asyncio">What’s asyncio?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#why-asyncio">Why asyncio?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-are-asyncio-basics">What are asyncio basics?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-does-telethon-sync-do">What does telethon.sync do?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-are-async-await-and-coroutines">What are async, await and coroutines?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#can-i-use-threads">Can I use threads?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#client-run-until-disconnected-blocks">client.run_until_disconnected() blocks!</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-else-can-asyncio-do">What else can asyncio do?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#why-does-client-start-work-outside-async">Why does client.start() work outside async?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#where-can-i-read-more">Where can I read more?</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Full API Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples/word-of-warning.html">A Word of Warning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/chats-and-channels.html">Working with Chats and Channels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/users.html">Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/working-with-messages.html">Working with messages</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developing/philosophy.html">Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing/test-servers.html">Test Servers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing/project-structure.html">Project Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing/coding-style.html">Coding Style</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing/testing.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing/understanding-the-type-language.html">Understanding the Type Language</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing/tips-for-porting-the-project.html">Tips for Porting the Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing/telegram-api-in-other-languages.html">Telegram API in Other Languages</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/changelog.html">Changelog (Version History)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/wall-of-shame.html">Wall of Shame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/compatibility-and-convenience.html">Compatibility and Convenience</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Telethon Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules/client.html">TelegramClient</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/events.html">Update Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/custom.html">Custom package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/utils.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/errors.html">API Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/sessions.html">Sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/network.html">Connection Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/helpers.html">Helpers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Telethon</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Mastering asyncio</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/concepts/asyncio.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mastering-asyncio">
<span id="id1"></span><h1><a class="toc-backref" href="#id2">Mastering asyncio</a><a class="headerlink" href="#mastering-asyncio" title="Permalink to this heading"></a></h1>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#mastering-asyncio" id="id2">Mastering asyncio</a></p>
<ul>
<li><p><a class="reference internal" href="#what-s-asyncio" id="id3">What’s asyncio?</a></p></li>
<li><p><a class="reference internal" href="#why-asyncio" id="id4">Why asyncio?</a></p></li>
<li><p><a class="reference internal" href="#what-are-asyncio-basics" id="id5">What are asyncio basics?</a></p></li>
<li><p><a class="reference internal" href="#what-does-telethon-sync-do" id="id6">What does telethon.sync do?</a></p></li>
<li><p><a class="reference internal" href="#what-are-async-await-and-coroutines" id="id7">What are async, await and coroutines?</a></p></li>
<li><p><a class="reference internal" href="#can-i-use-threads" id="id8">Can I use threads?</a></p></li>
<li><p><a class="reference internal" href="#client-run-until-disconnected-blocks" id="id9">client.run_until_disconnected() blocks!</a></p></li>
<li><p><a class="reference internal" href="#what-else-can-asyncio-do" id="id10">What else can asyncio do?</a></p></li>
<li><p><a class="reference internal" href="#why-does-client-start-work-outside-async" id="id11">Why does client.start() work outside async?</a></p></li>
<li><p><a class="reference internal" href="#where-can-i-read-more" id="id12">Where can I read more?</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="what-s-asyncio">
<h2><a class="toc-backref" href="#id3">What’s asyncio?</a><a class="headerlink" href="#what-s-asyncio" title="Permalink to this heading"></a></h2>
<p><a class="reference external" href="https://docs.python.org/3/library/asyncio.html#module-asyncio" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">asyncio</span></code></a> is a Python 3’s built-in library. This means it’s already installed if
you have Python 3. Since Python 3.5, it is convenient to work with asynchronous
code. Before (Python 3.4) we didn’t have <code class="docutils literal notranslate"><span class="pre">async</span></code> or <code class="docutils literal notranslate"><span class="pre">await</span></code>, but now we do.</p>
<p><a class="reference external" href="https://docs.python.org/3/library/asyncio.html#module-asyncio" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">asyncio</span></code></a> stands for <em>Asynchronous Input Output</em>. This is a very powerful
concept to use whenever you work IO. Interacting with the web or external
APIs such as Telegram’s makes a lot of sense this way.</p>
</section>
<section id="why-asyncio">
<h2><a class="toc-backref" href="#id4">Why asyncio?</a><a class="headerlink" href="#why-asyncio" title="Permalink to this heading"></a></h2>
<p>Asynchronous IO makes a lot of sense in a library like Telethon.
You send a request to the server (such as “get some message”), and
thanks to <a class="reference external" href="https://docs.python.org/3/library/asyncio.html#module-asyncio" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">asyncio</span></code></a>, your code won’t block while a response arrives.</p>
<p>The alternative would be to spawn a thread for each update so that
other code can run while the response arrives. That is <em>a lot</em> more
expensive.</p>
<p>The code will also run faster, because instead of switching back and
forth between the OS and your script, your script can handle it all.
Avoiding switching saves quite a bit of time, in Python or any other
language that supports asynchronous IO. It will also be cheaper,
because tasks are smaller than threads, which are smaller than processes.</p>
</section>
<section id="what-are-asyncio-basics">
<h2><a class="toc-backref" href="#id5">What are asyncio basics?</a><a class="headerlink" href="#what-are-asyncio-basics" title="Permalink to this heading"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># First we need the asyncio library</span>
<span class="kn">import</span> <span class="nn">asyncio</span>

<span class="c1"># Then we need a loop to work with</span>
<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

<span class="c1"># We also need something to run</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="s1">&#39;Hello, world!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># Then, we need to run the loop with a task</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="what-does-telethon-sync-do">
<h2><a class="toc-backref" href="#id6">What does telethon.sync do?</a><a class="headerlink" href="#what-does-telethon-sync-do" title="Permalink to this heading"></a></h2>
<p>The moment you import any of these:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">telethon</span> <span class="kn">import</span> <span class="n">sync</span><span class="p">,</span> <span class="o">...</span>
<span class="c1"># or</span>
<span class="kn">from</span> <span class="nn">telethon.sync</span> <span class="kn">import</span> <span class="o">...</span>
<span class="c1"># or</span>
<span class="kn">import</span> <span class="nn">telethon.sync</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">sync</span></code> module rewrites most <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">def</span></code>
methods in Telethon to something similar to this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">new_method</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">original_method</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
        <span class="c1"># the loop is already running, return the await-able to the user</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># the loop is not running yet, so we can run it for the user</span>
        <span class="k">return</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<p>That means you can do this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">get_me</span><span class="p">()</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
<p>Instead of this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">me</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">get_me</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">me</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>

<span class="c1"># or, using asyncio&#39;s default loop (it&#39;s the same)</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>  <span class="c1"># == client.loop</span>
<span class="n">me</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">get_me</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">me</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
<p>As you can see, it’s a lot of boilerplate and noise having to type
<code class="docutils literal notranslate"><span class="pre">run_until_complete</span></code> all the time, so you can let the magic module
to rewrite it for you. But notice the comment above: it won’t run
the loop if it’s already running, because it can’t. That means this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 3. the loop is running here</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_me</span><span class="p">()</span>  <span class="c1"># 4. this will return a coroutine!</span>
        <span class="o">.</span><span class="n">username</span>  <span class="c1"># 5. this fails, coroutines don&#39;t have usernames</span>
    <span class="p">)</span>

<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span>  <span class="c1"># 2. run the loop and the ``main()`` coroutine</span>
    <span class="n">main</span><span class="p">()</span>  <span class="c1"># 1. calling ``async def`` &quot;returns&quot; a coroutine</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Will fail. So if you’re inside an <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">def</span></code>, then the loop is
running, and if the loop is running, you must <code class="docutils literal notranslate"><span class="pre">await</span></code> things yourself:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">((</span><span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_me</span><span class="p">())</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>

<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="what-are-async-await-and-coroutines">
<h2><a class="toc-backref" href="#id7">What are async, await and coroutines?</a><a class="headerlink" href="#what-are-async-await-and-coroutines" title="Permalink to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">async</span></code> keyword lets you define asynchronous functions,
also known as coroutines, and also iterate over asynchronous
loops or use <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># ^ this declares the main() coroutine function</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">:</span>
        <span class="c1"># ^ this is an asynchronous with block</span>

        <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">iter_messages</span><span class="p">(</span><span class="n">chat</span><span class="p">):</span>
            <span class="c1"># ^ this is a for loop over an asynchronous generator</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="c1"># ^ this assigns the default event loop from the main thread to a variable</span>

<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
<span class="c1"># ^ this runs the *entire* loop until the main() function finishes.</span>
<span class="c1">#   While the main() function does not finish, the loop will be running.</span>
<span class="c1">#   While the loop is running, you can&#39;t run it again.</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">await</span></code> keyword blocks the <em>current</em> task, and the loop can run
other tasks. Tasks can be thought of as “threads”, since many can run
concurrently:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">delay</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>  <span class="c1"># await tells the loop this task is &quot;busy&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>  <span class="c1"># eventually the loop resumes the code here</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">world</span><span class="p">(</span><span class="n">delay</span><span class="p">):</span>
    <span class="c1"># the loop decides this method should run first</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>  <span class="c1"># await tells the loop this task is &quot;busy&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">)</span>  <span class="c1"># eventually the loop finishes all tasks</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>  <span class="c1"># get the default loop for the main thread</span>
<span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">world</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># create the world task, passing 2 as delay</span>
<span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">hello</span><span class="p">(</span><span class="n">delay</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># another task, but with delay 1</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># run the event loop forever; ctrl+c to stop it</span>
    <span class="c1"># we could also run the loop for three seconds:</span>
    <span class="c1">#     loop.run_until_complete(asyncio.sleep(3))</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>The same example, but without the comment noise:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">delay</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">world</span><span class="p">(</span><span class="n">delay</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">)</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">world</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">hello</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="can-i-use-threads">
<h2><a class="toc-backref" href="#id8">Can I use threads?</a><a class="headerlink" href="#can-i-use-threads" title="Permalink to this heading"></a></h2>
<p>Yes, you can, but you must understand that the loops themselves are
not thread safe. and you must be sure to know what is happening. The
easiest and cleanest option is to use <a class="reference external" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.run" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">asyncio.run</span></code></a> to create and manage
the new event loop for you:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">actual_work</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">TelegramClient</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>
    <span class="o">...</span>  <span class="c1"># can use `await` here</span>

<span class="k">def</span> <span class="nf">go</span><span class="p">():</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">actual_work</span><span class="p">())</span>

<span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">go</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>Generally, <strong>you don’t need threads</strong> unless you know what you’re doing.
Just create another task, as shown above. If you’re using the Telethon
with a library that uses threads, you must be careful to use <a class="reference external" href="https://docs.python.org/3/library/threading.html#threading.Lock" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">threading.Lock</span></code></a>
whenever you use the client, or enable the compatible mode. For that, see
<a class="reference internal" href="../misc/compatibility-and-convenience.html#compatibility-and-convenience"><span class="std std-ref">Compatibility and Convenience</span></a>.</p>
<p>You may have seen this error:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>RuntimeError: There is no current event loop in thread &#39;Thread-1&#39;.
</pre></div>
</div>
<p>It just means you didn’t create a loop for that thread, and if you don’t
pass a loop when creating the client, it uses <code class="docutils literal notranslate"><span class="pre">asyncio.get_event_loop()</span></code>,
which only works in the main thread.</p>
</section>
<section id="client-run-until-disconnected-blocks">
<h2><a class="toc-backref" href="#id9">client.run_until_disconnected() blocks!</a><a class="headerlink" href="#client-run-until-disconnected-blocks" title="Permalink to this heading"></a></h2>
<p>All of what <a class="reference internal" href="../modules/client.html#telethon.client.updates.UpdateMethods.run_until_disconnected" title="telethon.client.updates.UpdateMethods.run_until_disconnected"><code class="xref py py-obj docutils literal notranslate"><span class="pre">client.run_until_disconnected()</span></code></a> does is
run the <a class="reference external" href="https://docs.python.org/3/library/asyncio.html#module-asyncio" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">asyncio</span></code></a>’s event loop until the client is disconnected. That means
<em>the loop is running</em>. And if the loop is running, it will run all the tasks
in it. So if you want to run <em>other</em> code, create tasks for it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">clock</span><span class="p">():</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The time:&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">clock</span><span class="p">())</span>
<span class="o">...</span>
<span class="n">client</span><span class="o">.</span><span class="n">run_until_disconnected</span><span class="p">()</span>
</pre></div>
</div>
<p>This creates a task for a clock that prints the time every second.
You don’t need to use <a class="reference internal" href="../modules/client.html#telethon.client.updates.UpdateMethods.run_until_disconnected" title="telethon.client.updates.UpdateMethods.run_until_disconnected"><code class="xref py py-obj docutils literal notranslate"><span class="pre">client.run_until_disconnected()</span></code></a> either!
You just need to make the loop is running, somehow. <code class="xref py py-obj docutils literal notranslate"><span class="pre">loop.run_forever()</span></code> and <a class="reference external" href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.loop.run_until_complete" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">loop.run_until_complete()</span></code></a> can also be used to run
the loop, and Telethon will be happy with any approach.</p>
<p>Of course, there are better tools to run code hourly or daily, see below.</p>
</section>
<section id="what-else-can-asyncio-do">
<h2><a class="toc-backref" href="#id10">What else can asyncio do?</a><a class="headerlink" href="#what-else-can-asyncio-do" title="Permalink to this heading"></a></h2>
<p>Asynchronous IO is a really powerful tool, as we’ve seen. There are plenty
of other useful libraries that also use <a class="reference external" href="https://docs.python.org/3/library/asyncio.html#module-asyncio" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">asyncio</span></code></a> and that you can integrate
with Telethon.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/aio-libs/aiohttp">aiohttp</a> is like the infamous
<a class="reference external" href="https://github.com/requests/requests/">requests</a> but asynchronous.</p></li>
<li><p><a class="reference external" href="https://gitlab.com/pgjones/quart">quart</a> is an asynchronous alternative
to <a class="reference external" href="http://flask.pocoo.org/">Flask</a>.</p></li>
<li><p><a class="reference external" href="https://github.com/gawel/aiocron">aiocron</a> lets you schedule things
to run things at a desired time, or run some tasks hourly, daily, etc.</p></li>
</ul>
<p>And of course, <a class="reference external" href="https://docs.python.org/3/library/asyncio.html">asyncio</a>
itself! It has a lot of methods that let you do nice things. For example,
you can run requests in parallel:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">last</span><span class="p">,</span> <span class="n">sent</span><span class="p">,</span> <span class="n">download_path</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s1">&#39;telegram&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="n">client</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;Using asyncio!&#39;</span><span class="p">),</span>
        <span class="n">client</span><span class="o">.</span><span class="n">download_profile_photo</span><span class="p">(</span><span class="s1">&#39;telegram&#39;</span><span class="p">)</span>
    <span class="p">)</span>

<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
<p>This code will get the 10 last messages from <a class="reference external" href="https://t.me/telegram">&#64;telegram</a>, send one to the chat with yourself, and also
download the profile photo of the channel. <a class="reference external" href="https://docs.python.org/3/library/asyncio.html#module-asyncio" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">asyncio</span></code></a> will run all these
three tasks at the same time. You can run all the tasks you want this way.</p>
<p>A different way would be:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s1">&#39;telegram&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;Using asyncio!&#39;</span><span class="p">))</span>
<span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">download_profile_photo</span><span class="p">(</span><span class="s1">&#39;telegram&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>They will run in the background as long as the loop is running too.</p>
<p>You can also <a class="reference external" href="https://docs.python.org/3/library/asyncio-stream.html#asyncio.start_server">start an asyncio server</a>
in the main script, and from another script, <a class="reference external" href="https://docs.python.org/3/library/asyncio-stream.html#asyncio.open_connection">connect to it</a>
to achieve <a class="reference external" href="https://en.wikipedia.org/wiki/Inter-process_communication">Inter-Process Communication</a>.
You can get as creative as you want. You can program anything you want.
When you use a library, you’re not limited to use only its methods. You can
combine all the libraries you want. People seem to forget this simple fact!</p>
</section>
<section id="why-does-client-start-work-outside-async">
<h2><a class="toc-backref" href="#id11">Why does client.start() work outside async?</a><a class="headerlink" href="#why-does-client-start-work-outside-async" title="Permalink to this heading"></a></h2>
<p>Because it’s so common that it’s really convenient to offer said
functionality by default. This means you can set up all your event
handlers and start the client without worrying about loops at all.</p>
<p>Using the client in a <code class="docutils literal notranslate"><span class="pre">with</span></code> block, <a class="reference internal" href="../modules/client.html#telethon.client.auth.AuthMethods.start" title="telethon.client.auth.AuthMethods.start"><code class="xref py py-obj docutils literal notranslate"><span class="pre">start</span></code></a>, <a class="reference internal" href="../modules/client.html#telethon.client.updates.UpdateMethods.run_until_disconnected" title="telethon.client.updates.UpdateMethods.run_until_disconnected"><code class="xref py py-obj docutils literal notranslate"><span class="pre">run_until_disconnected</span></code></a>, and
<a class="reference internal" href="../modules/client.html#telethon.client.telegrambaseclient.TelegramBaseClient.disconnect" title="telethon.client.telegrambaseclient.TelegramBaseClient.disconnect"><code class="xref py py-obj docutils literal notranslate"><span class="pre">disconnect</span></code></a>
all support this.</p>
</section>
<section id="where-can-i-read-more">
<h2><a class="toc-backref" href="#id12">Where can I read more?</a><a class="headerlink" href="#where-can-i-read-more" title="Permalink to this heading"></a></h2>
<p><a class="reference external" href="https://lonami.dev/blog/asyncio/">Check out my blog post</a> about <a class="reference external" href="https://docs.python.org/3/library/asyncio.html#module-asyncio" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">asyncio</span></code></a>, which
has some more examples and pictures to help you understand what happens
when the loop runs.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="botapi-vs-mtproto.html" class="btn btn-neutral float-left" title="HTTP Bot API vs MTProto" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../examples/word-of-warning.html" class="btn btn-neutral float-right" title="A Word of Warning" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017 - 2019, Lonami.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>